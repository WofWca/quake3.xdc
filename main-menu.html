<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="color-scheme" content="dark light">
    <title>Main menu - Quake III Arena</title>

    <style>
        body:not(.haveFullVersion) .ifHaveFullVersion {
            display: none;
        }
        body.haveFullVersion .ifNotHaveFullVersion {
            display: none;
        }

        html, body {
            /* TODO properly style the page. */
            font-family: "Antonio", sans-serif;
            font-optical-sizing: auto;
            font-weight: 700;
            font-style: normal;
            letter-spacing: -.05ch;

            font-size: xx-large;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #openFileExplorerBtn {
            height: 30px;
            font-family: "Antonio", sans-serif;
            font-optical-sizing: auto;
            font-weight: 700;
            font-style: normal;
            letter-spacing: -.05ch;
        }

        #closeFileExplorerBtn {
            height: 30px;
            width: 30px;
        }

        #fileExplorerDialog {
            font-size: medium;
            padding: 5px;
            width: 80vw;
            height: 80vh;
        }

        #fileExplorerContainer {
            height: 100%;
            display: flex;
            flex-direction: column;
        }
    </style>

    <script type="module">
        // The source of truth of whether we have the full version
        // is whether we have the files in cache.
        // But this quick check is fine.
        // Even if this value does not reflect reality, we are able to recover.
        if (localStorage.getItem('haveFullVersion') === 'true') {
            document.body.classList.add('haveFullVersion');
        }
    </script>

    <!-- https://github.com/DavidSM100/emscripten-fs-file-explorer-ui -->
    <script src="./emscripten-fs-file-explorer-ui.iife.js"></script>

    <script src="webxdc.js"></script>
    
    <!-- https://codeberg.org/DavidSM100/webxdc-download-polyfill -->
    <script src="./webxdc-download-polyfill.js"></script>
</head>

<body>
    <a
        class="ifHaveFullVersion"
        href="./index.html?basegame=baseq3"
    >Play full game</a>
    <br class="ifHaveFullVersion">

    <!-- It's important to keep a way to play demo such that people
    are always able to play together. -->
    <a href="./index.html?basegame=demoq3">Play demo</a>
    <br>

    <a
        class="ifNotHaveFullVersion"
        href="./upload-full-version.html?basegame=baseq3"
    >Unlock all maps</a>

    <p>
        <!-- TODO automatically do this, and remove this paragraph. -->
        Remember that in order to play the game together,
        all players must pick the same type of game
        (either the full game or the demo).
    </p>

    <button id="openFileExplorerBtn" style="margin-top: 10px;">Open File Explorer</button>
    <div style="font-size: medium;">
        <p>
            The File Explorer lets you edit the game config files
            (<code>autoexec.cfg</code>, <code>q3config.cfg</code>),
            install game mods, and do other fun stuff.
        </p>
        <p>
            For example, to be a true pro, change the field of view
            by adding a line <code>set cg_fov 110</code>
            at the end of <code>autoexec.cfg</code>.
        </p>
        <p>
            <a
                href="https://web.archive.org/web/20250421121019/https://forum.fpsclassico.com/quake-3-config.php"
            >https://web.archive.org/web/20250421121019/https://forum.fpsclassico.com/quake-3-config.php</a>
            is a nice guide on Quake config variables.
        </p>
        <p>
            For a list of mods, see
            <a
                href="https://www.moddb.com/games/quake-iii-arena/mods"
            >https://www.moddb.com/games/quake-iii-arena/mods</a>.
        </p>
    </div>

    <dialog id="fileExplorerDialog">
        <div id="fileExplorerContainer">
            <div style="text-align: right; margin-bottom: 5px;">
                <button id="closeFileExplorerBtn">
                     <b>X</b>
                </button>
            </div>
        </div>
    </dialog>

    <script>
        const dialog = document.getElementById("fileExplorerDialog");
        const fileExplorerContainer = document.getElementById("fileExplorerContainer");
        document.getElementById("closeFileExplorerBtn").onclick = () => {
            const container = document.getElementById("fileExplorerDiv");
            dialog.close();
        }

        dialog.addEventListener("close", () => {
            const container = document.getElementById("fileExplorerDiv");
            container.remove();
        })

        const openFileExplorerBtn = document.getElementById("openFileExplorerBtn");
        openFileExplorerBtn.onclick = async () => {
            openFileExplorerBtn.disabled = true;
            const container = document.createElement("div");
            container.style.flex = "1";
            container.id = "fileExplorerDiv";
            const ioquake3 = await import("/ioquake3_opengl2.wasm32.js");
            const module = await ioquake3.default();
            module.FS.mkdirTree("/home/web_user/.q3a");
            module.FS.mount(module.FS.filesystems.IDBFS, {}, "/home/web_user/.q3a");
            module.FS.syncfs(true, (err) => {
                if (err) {
                    console.error(err);
                }
                mountEmscriptenFileExplorer(container, module.FS, {
                    initialDir: "/home/web_user/.q3a"
                });
                fileExplorerContainer.append(container);
                dialog.showModal();
                openFileExplorerBtn.disabled = false;
            });
        }
    </script>
</body>

</html>